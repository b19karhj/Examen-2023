<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <style>
        #container{
            display: flex;
            flex-direction: row;
        }
        .arraySegments{
            border-radius: 2px solid black;
            margin-right: 10px;
        }
         
        #page1{
            display:block;
            width: 100%;
            min-height: 100%;
            position: fixed;
        }
        #page2{
            display: none;
            width: 100%;
            min-height: 100%;
            position: absolute;
        }
        #formContainer{
            width: 50%;
            height: 80%;
            margin:auto;
            
        }
        form{
            border: 2px solid black;
        }
        .formL{
            padding-top: 10px;
            display:inline-block;
            font-size: 1.05em;
            
        }
        fieldset{
            border: 2px solid black;
            margin: 10px;
            padding-right: 5px;
            padding-bottom: 5px;
          
        }
        input{
            margin: 5px;
           
        }
        #formH{
            text-align: center;
        }
      
    </style>
</head>
<body onload="">
    <!-- Password box for google guidline passwords-->
    <div id="page1">
        <div>
            <label for="noMSA">Password 1</label>
            <input type="text" id="noMSA" name="noMSA">
            <input type="submit" value="submit1">
        </div>
        <!-- Password box for MSA passwords-->
        <div>
            <label for="MSA">Password 2</label>
            <input type="text" id="MSA" name="MSA">
            <input type="submit" value="submit2" onclick="MSA();">
            <div id="container" class="arraySegments"></div>
        </div>
    </div>
    <div id="page2">
        <div id="formContainer">
        <form>
            <h1 id="formH">Your password have been accepted!</h1>
            <div class="arraySegments"></div>
            <fieldset>
            <label class="formL" for="q1">Was the segmentation of your password corrrect?</label>
                <br>
                <label>Yes</label>
                    <input type="radio" class="q1a" name="q1" value="yes"><br>
                <label>No</label>
                    <input type="radio" class="q1a" name="q1" value="no">
                <br>
            </fieldset>
            <fieldset>
            <label class="formL" for="q2">Did the validation service for segmented password help you create a stronger password then you did with the Googles guidelines?</label>
                <br>
                <label>Yes</label>
                    <input type="radio" id="q2yes" name="q2" value="yes"><br>
                <label>No</label>
                    <input type="radio" id="q2no"  name="q2" value="no"><br>
                <label>Indifferent</label>
                    <input type="radio" id="q2same" name="q2" values="Indifferent"><br>
                <label>Worse</label>
                    <input type="radio" id="q2worse" name="q2" values="worse">
                <br>
            </fieldset>
            <fieldset>
            <label class="formL" for="q3">Do you think the segmented password you created would be easy to remember?</label>
                <br>
                <label>Yes</label>
                    <input type="radio" id="q3yes" name="q3" value="yes"><br>
                <label>No</label>
                    <input type="radio" id="q3no"  name="q3" value="no">
                <br>
            </fieldset>
            <fieldset>
            <label class="formL" for="q4">Was the feedback given helpful, if one or more segments were not deemed safe?</label>
                <br>
                <label>Yes</label>
                    <input type="radio" id="q4yes" name="q4" value="yes"><br>
                <label>No</label>
                    <input type="radio" id="q4no"  name="q4" value="no"><br>
                <label>My password got accepted on the first attempt</label>
                    <input type="radio" id="q4first"  name="q4" value="accepted">
                <br>
            </fieldset>
            <fieldset>
            <label class="formL" for="q5">How many attempts did it take you to get your password accepted?</label>
                <br>
                <label>1 attempt</label>
                    <input type="radio" id="q51" name="q5" value="1"><br>
                <label>Less than 3 attepmts</label>
                    <input type="radio" id="q5less"  name="q5" value="lessthan3"><br>
                <label>More than 3 attempts</label>
                    <input type="radio" id="q5more"  name="q5" value="morethan3">
                <br>
            </fieldset>
            <fieldset>
            <label class="formL" for="q6">If this validation service was optimized would you prefer it over Goggles validation service they use for their current services?</label>
                <br>
                <label>Yes</label>
                    <input type="radio" id="q6yes" name="q6" value="1"><br>
                <label>No</label>
                    <input type="radio" id="q6no"  name="q6" value="lessthan3"><br>
                <label>Indifferent</label>
                    <input type="radio" id="q6Indifferent"  name="q6" value="Indifferent">
                <br>
            </fieldset>
            <input type="submit" value="Submit" onclick="ajaxQuestion();"></submit>
        </form>
        </div>
    </div>
    <script> 
         //var words; //Global veriabel som håller innehåller alla ord från ordlistan.

       
        //Function for local files.
         /*function compareText(){  //Skriv kommentarer imorgon.
            fetch("wordList.txt") //Hämtar textfilen.
                .then(function(textFile){ //En promise some tar emot datan och en response.
                    return (textFile.text()); //Splitar innehållet på "\n".
            })
            .then(function(data){  //Tar emot datan från returnen.
                words = data.split("\r\n"); //Splittar textfilen och sparar i strängen.
            })
        }*/ 
        function wordChecker(word){
            return new Promise ((resolve,reject) => {
                fetch('https://api.dictionaryapi.dev/api/v2/entries/en/'+word+'')
                    .then(response => response.json())
                    .then(response => {
                        if(response.hasOwnProperty("title")){ //Checks if response object has property word.
                            resolve(false);
                            
                        }else{
                            resolve(true)
                        }
                        
                    }) 
                
                })
                
            }//If timed out again. Create catch error and refere to v1 of the api
        
        function ajaxFunction(nonchangedPassword,readyForSend){
            var noSegP = JSON.stringify(nonchangedPassword);
            var segP = JSON.stringify(readyForSend);
            let result;
            result = $.ajax( "./Backend.php" ,{
                type: 'POST',
                data: { 
                    noSegPassword: noSegP,
                    segPassword: segP	
                }
            })
            return result;    
        }

        function ajaxQuestion(){
            var q1 = JSON.stringify(document.querySelector("input[name='q1']:checked").value);
            var q2 = JSON.stringify(document.querySelector("input[name='q2']:checked").value);
            var q3 = JSON.stringify(document.querySelector("input[name='q3']:checked").value);
            var q4 = JSON.stringify(document.querySelector("input[name='q4']:checked").value);
            var q5 = JSON.stringify(document.querySelector("input[name='q5']:checked").value);
            var q6 = JSON.stringify(document.querySelector("input[name='q6']:checked").value);
            //var pass = JSON.stringify(nonchangedPassword);
            $.ajax( "./Backend.php" ,{
                type: 'POST',
                answers: { 
                    q1: q1,
                    q2: q2,
                    q3: q3,
                    q4: q4,
                    q5: q5,
                    q6: q6
                    
                }
            }) 
           
            
        }

        function clearElements(prepareForSend){
            console.log(prepareForSend);
            if(prepareForSend != null){
                const list = document.getElementById("container");
                while (list.hasChildNodes()) {
                    list.removeChild(list.firstChild);
                }
                
            }
        }

        //Algorithm for MSA
       async function MSA(){
            //Varibales
            var password; //Holds passwords from password 2
            var noSpecialCharPassword;
            var searchingWord;
            var leetSearchingWord; //Stores the password created while last character is deleted.
            var wordDetector = 0;
            var expectedPassword = [];
            var readyForSend = [];
            var prepareForSend = [];
            var expectedPassword2 = [];
            var segmentationTracker = []; //Keeps track of all segmentations
            var leetSegmentationTracker = [];
            var MSACheck = true;
            var segmentedPassword = [];
            var segmentbolean = true;
            var segmentExpectbolean = true;
            var passwordCharChange;
            var expectedPassword = [];
            var expectedPasswordArray = [];
            var savedWords = [];
            var storeSpecialWords = [];
            const containSpeicalCharacter = (/\W/);
            const specialLetters = (/\d/);
            const replaceSpecialChars = { //Created objects
                "@":"a",
                "0":"o"
            }
            var cleanPassword;
            var segmentioningPassword = true;
            var databasePassword = false;
            var nonchangedPassword;
            var returnData;
            var returnWait = false;
            password = document.getElementById("MSA").value;
            nonchangedPassword = password;
            cleanPassword = password;

            if(password.match(containSpeicalCharacter) || password.match(specialLetters) ){
        
                noSpecialCharPassword = password.replace(/@|0/g, function(matched){ //Replaces all specialChars with mapped letters
                    return replaceSpecialChars[matched];
                });

            }else{
                noSpecialCharPassword = password;
            }
            

            while(segmentioningPassword == true){
                
                const alphabet = /^[a-zA-Z]/ //Regex if first char is lower and uppercase charecter
                const alphabet2 = (/[a-z]/);
                const number = /^[0-9]/; //Regex Numbers
                const numbers = (/[0-9]/);
                const notNumber = /^\D/;
                const lastCharNr = (/|0-9]$/);
                const lastCharAP = (/[a-zA-Z]$/);
                const specialCharacter = /^\W/; //Regex special characters
                var wordProcess = false;

                
                /*TODO:
                Efter det fråga mot databasen.
                Efter det formulera tydliga riktlinjer
                Efter det skapa formulär
                Samla in data*/

                for (let i = 0; i < password.length; i++){
                    if(password.match(number)){
                     
                        segmentationTracker.push(password.match(number))
                        password = password.substring(1);

                    }else if(password.match(specialCharacter)){
                        segmentationTracker.push(password.match(specialCharacter))
                        password = password.substring(1);
                    }else{
                        let fetchWord;
                        searchingWord = password.substring(0, password.length - i)
                        fetchWord = await wordChecker(searchingWord); // calls on wordChecker and waits for it to complete

                        if(fetchWord){
                            segmentationTracker.push(searchingWord); //Adds the word to segmentation tracker
                            password = password.replace(`${searchingWord}`, ""); //Replaces the word in password string with nothing.
                            i = 0; //Behövs eftersom en stor del text har försvunnit och annars enbart visar första bokstaven i vad som är kvar
                            
                        }else if(searchingWord.length <= 1){ //If temp.length is less then 1 in length, enter here to remove characters.
                            segmentationTracker.push(searchingWord[0]);
                            password = password.substring(1);
                        
                        }
                        
                    }
                    
                };
                
                if(password.length == 0 ){

                    for (let i = 0; i < noSpecialCharPassword.length; i++){
                        if(noSpecialCharPassword.match(number)){

                            leetSegmentationTracker.push(noSpecialCharPassword.match(number))
                            storeSpecialWords.push(noSpecialCharPassword.match(number));
                            noSpecialCharPassword = noSpecialCharPassword.substring(1);
                         
                        }else if(noSpecialCharPassword.match(specialCharacter)){
                            
                            leetSegmentationTracker.push(noSpecialCharPassword.match(specialCharacter))
                            storeSpecialWords.push(noSpecialCharPassword.match(specialCharacter));
                            noSpecialCharPassword = noSpecialCharPassword.substring(1);

                        }else{
                            let fetchLeetWord;
                            leetSearchingWord = noSpecialCharPassword.substring(0, noSpecialCharPassword.length - i);
                            fetchLeetWord = await wordChecker(leetSearchingWord);

                            if(fetchLeetWord){
                                console.log("Word found :",leetSearchingWord)
                                leetSegmentationTracker.push(leetSearchingWord); //Adds the word to segmentation tracker
                                storeSpecialWords.push(" ");
                                noSpecialCharPassword = noSpecialCharPassword.replace(`${leetSearchingWord}`, ""); //Replaces the word in password string with nothing.
                                i = 0; //Behövs eftersom en stor del text har försvunnit och annars enbart visar första bokstaven i vad som är kvar
                            }
                            else if(leetSearchingWord.length <= 1){
                                leetSegmentationTracker.push(leetSearchingWord[0]);
                                storeSpecialWords.push(leetSearchingWord[0]);
                                noSpecialCharPassword = noSpecialCharPassword.substring(1);
                            }
                        }
                        
                    }
                   
                }
                //Problem solved with single letters.
                if(noSpecialCharPassword == 0 && cleanPassword != ""){
                    let temptext;
                    for(let i = 0; i < leetSegmentationTracker.length; i++){
                        temptext = leetSegmentationTracker[i].toString(); 
                        if(leetSegmentationTracker[i].length >= 1 && temptext.match(alphabet)){
                            if (savedWords.length != 0){
                                savedWords.push("-");

                            }
                            for(let j = 0; j < leetSegmentationTracker[i].length; j++){
                                savedWords.push(cleanPassword[j])
                            }

                        }else{
                            cleanPassword = cleanPassword.substring(0);
                        }
                        cleanPassword = cleanPassword.substring(leetSegmentationTracker[i].length)
                    }
                    savedWords = savedWords.join('').split(/-/g);
                    wordProcess = true;
                    
                };
                
                if(wordProcess == true){

                    var segments;
                    var segmentsExpected;
                 
                    segments = segmentationTracker.toString().split(/,/g);//Converts to string and split and save it to varibal segments
                    segmentsExpected = storeSpecialWords.toString().split(/,/g); 


                    if(segmentedPassword.length == 0){
                        segmentedPassword = segmentedPassword.concat(segments[0]);
                        expectedPassword = expectedPassword.concat(segmentsExpected[0]);
                        segments = segments.slice(1);
                        segmentsExpected = segmentsExpected.slice(1);                           

                    }
                    for(let i = 0; segments.length > 0; i++){

                        if(segmentedPassword[i] == ","){ //If , == i, then add 1 to i
                            i++;
                        }
                        if(segmentedPassword[i].match(numbers) && segments[0].match(numbers) ||
                                segmentedPassword[i].match(specialCharacter) && segments[0].match(specialCharacter) ||
                                segmentedPassword[i].match(alphabet) && segments[0].match(alphabet) 
                            ){//If i and segment0 is the same char 

                                segmentedPassword = segmentedPassword.concat(segments[0]);
                                segments = segments.slice(1);

                        }else{ //if element [i] does not match the char in segments[0]
                            
                            segmentedPassword = segmentedPassword.concat(",",segments[0]); //Cocats , and element to string.
                            segments = segments.slice(1); //Revmoves first element
                        
                        }
                        
                        if(segments.length == 0){ // Exit loop.
                            
                            for(let j = 0; segmentsExpected.length > 0; j++){
                                
                                if(expectedPassword[j] == ","){ //If , == j, then add 1 to j
                                    j++;
                                }

                                if(expectedPassword[j].match(numbers) && segmentsExpected[0].match(numbers) ||
                                        expectedPassword[j].match(specialCharacter) && segmentsExpected[0].match(specialCharacter) ||
                                        expectedPassword[j].match(alphabet) && segmentsExpected[0].match(alphabet)
                                    ){//If j and segment0 is the same char 

                                    expectedPassword = expectedPassword.concat(segmentsExpected[0]);
                                    segmentsExpected = segmentsExpected.slice(1);
                                    
                                }else{ //if element [j] does not match the char in segments[0]
                                    expectedPassword = expectedPassword.concat(",",segmentsExpected[0]);//Cocats , and element to string.
                                    segmentsExpected = segmentsExpected.slice(1); //Revmoves first element
                                
                                } 
                                if(segmentsExpected.length < 1){ // Exit loop.
                    
                                    for (let i = 0; i < expectedPassword.length; i++){
        
                                        if(expectedPassword[i] == " "){
                                            if(expectedPassword[i+1] == " "){
                                                expectedPassword[i] = savedWords[0]+",";
                                                savedWords = savedWords.slice(1);
                                            }else{

                                                expectedPassword[i] = savedWords[0];
                                                savedWords = savedWords.slice(1);
                                            }
                                            
                                        }else if(expectedPassword[i].length == 1 && expectedPassword[i] == savedWords[0]){ // its a single letter and its counted in savewords this will just replace the single letter to avoid out of bound error
                                            expectedPassword[i] = savedWords[0];
                                            savedWords = savedWords.slice(1);
                                        }
                                    
                                    }
                                    clearElements(prepareForSend);
                                    segmentedPassword = segmentedPassword.join(""); //Joins the array to a string and splits at ","
                                    expectedPassword = expectedPassword.join("");
                                    console.log("The segmentedPassword is: ", segmentedPassword, "The expected password is: ", expectedPassword);
                                    prepareForSend = expectedPassword.split(/,/g); 
                                    
                                    const container = document.getElementById("container"); //Fetch id
                                    for(let i = 0; i < prepareForSend.length; i++){ 
                                        var divBoxes = document.createElement("div"); //create span element
                                        divBoxes.classList.add("arraySegments"); // Add .item
                                        divBoxes.textContent = prepareForSend[i]; //Add textcontent from current value of testa.
                                        container.appendChild(divBoxes); //Append to span to container
                                    }
                                    for (let i = 0; i < prepareForSend.length; i++){ 
                                        if(prepareForSend[i].length <= 2){
                                            readyForSend.push('');
                                        }else{
                                            readyForSend.push(prepareForSend[i]);
                                            
                                        }
                                    };
                                    
                                    
                                    databasePassword = true;
                                    segmentioningPassword = false;

                                }       
                            }
                                
                        }
                            
                    };
  
                }
            }
                //console.log(expectedPassword)
               
                //expectedPassword1
                var returnValue;
                returnValue = await ajaxFunction(nonchangedPassword,readyForSend);
                returnValue = JSON.parse(returnValue);
                console.log(returnValue)
                if(returnValue == true){
                    alert("The password "+segmentedPassword+" has been leaked before and is not safe! Try a different password")
                    
                }
                else{
                    var outputElements = document.getElementsByClassName("arraySegments"); //Fetch class
                    for(let i = 0; i < returnValue.length; i++){
                        if(returnValue[i] < 2000){
                            outputElements[i+1].style.backgroundColor="green"; //i+1 beacuse 0 is always empety and first word is at postion 1
                        }else{
                            outputElements[i+1].style.backgroundColor="red";
                        }
                    }
                }
                var colortest = true;
                for(let i = 1; i < outputElements.length; i++){
                    if(outputElements[i].style.backgroundColor == "red"){
                        colortest = false;
                        break;
                    }
                    else{

                    }
                }
                
                if(colortest == false){
                    alert("One or more segments are not accepted");
                    
                }else if(colortest == true){
                    document.getElementById("page1").style.display = "none";
                    document.getElementById("page2").style.display = "block";
                }
                   
                
               

        }

    </script>
</body>
</html>
